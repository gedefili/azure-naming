name: Postman collection

on:
  workflow_dispatch: {}

jobs:
  newman:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Node (for npx/newman)
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Run Postman collection with Newman
        env:
          POSTMAN_BEARER_TOKEN: ${{ secrets.POSTMAN_BEARER_TOKEN }}
        run: |
          if [ -n "$POSTMAN_BEARER_TOKEN" ]; then
            jq --arg token "$POSTMAN_BEARER_TOKEN" '.values |= map(if .key=="auth_token" then .value=$token else . end)' tests/postman_environment.json > /tmp/env.json
          else
            cp tests/postman_environment.json /tmp/env.json
          fi
          npx newman@6 run tests/postman_collection.json -e /tmp/env.json --insecure
